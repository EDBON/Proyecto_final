{% extends 'auxiliar.html' %}

{% block title %}Crear Cita{% endblock %}

{% block content %}
<div class="container">
    <h2>Crear Cita</h2>
    <form method="POST">
        {% csrf_token %}
        
        <!-- Renderizar manualmente los campos del formulario -->
        <div class="mb-3">
            <label for="id_persona" class="form-label">Persona</label>
            {{ form.persona }}  <!-- Renderiza el campo persona (select de personas) -->
        </div>

        <div class="mb-3">
            <label for="id_sala" class="form-label">Sala</label>
            {{ form.sala }}
        </div>
        
        <div class="mb-3">
            <label for="id_fecha" class="form-label">Fecha</label>
            {{ form.fecha }}  <!-- Campo para la fecha -->
        </div>

        <div class="mb-3">
            <label for="id_hora" class="form-label">Hora</label>
            {{ form.hora }}  <!-- Campo para la hora -->
        </div>

        <div class="mb-3">
            <label for="id_is_active" class="form-label">Activo</label>
            {{ form.is_active }}  <!-- Campo de activación (checkbox) -->
        </div>

        <div class="mb-3">
            <label for="id_tipo" class="form-label">Tipo</label>
            {{ form.tipo }}  <!-- Campo para tipo -->
        </div>

        <div class="mb-3">
            <label for="id_empleado" class="form-label">Empleado</label>
            <select id="id_empleado" name="id_empleado" class="select2">
                <option value="">Seleccione un médico</option>
                <!-- Los médicos se cargarán aquí mediante AJAX -->
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Guardar</button>
        <a href="{% url 'listar_citas' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- Incluir los estilos y scripts de Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Cargar el archivo de idioma en español -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
    // Iniciar Flatpickr para fecha
    flatpickr(".flatpickr", {
        dateFormat: "Y-m-d",  // Formato de la fecha (AAAA-MM-DD)
        altInput: true,       // Muestra el valor en un formato más amigable
        altFormat: "F j, Y",  // Formato alternativo (Ej: 20 de Marzo de 2025)
        locale: "es",         // Cambia el idioma al español
        minDate: "today",     // Restringe fechas anteriores a hoy
        maxDate: new Date().fp_incr(5 * 365) // Máximo: 5 años desde hoy
    });

    // Iniciar Flatpickr para hora
    flatpickr(".flatpickr-time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",  // Formato de 24 horas (HH:MM)
        time_24hr: true,     // Asegura que use formato 24 horas
        locale: "es",
    });
</script>

<!-- Estilos y Scripts de Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Inicializar Select2 en todos los campos select
        $('.select2').select2();

        // AJAX para cargar médicos según la especialidad seleccionada
        $('#id_tipo').change(function() {
            var especialidad = $(this).val();  // Obtenemos la especialidad seleccionada
            if (especialidad) {
                $.ajax({
                    url: "{% url 'api_empleados_por_especialidad' %}",  // Asegúrate de que esta URL esté correctamente configurada en urls.py
                    data: {
                        'especialidad': especialidad
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_empleado').empty();  // Limpiar el select de empleados
                        $('#id_empleado').append('<option value="">Seleccione un médico</option>'); // Opción inicial

                        // Rellenar el select con los empleados de esa especialidad
                        $.each(data, function(index, empleado) {
                            $('#id_empleado').append('<option value="' + empleado.id + '">' + empleado.nombre + '</option>');
                        });

                        // Volver a inicializar el select2 para que lo reconozca
                        $('#id_empleado').select2();
                    }
                });
            } else {
                $('#id_empleado').empty();  // Limpiar el select si no hay especialidad seleccionada
                $('#id_empleado').append('<option value="">Seleccione una especialidad primero</option>');
            }
        });
    });
</script>

{% endblock %}
